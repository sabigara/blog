---
title: '2022-02-18'
date: '2022-02-18'
tags: ['journal']
draft: false
layout: PostSimple
---

Reaktr の書き出し機能はなんとか実用レベルの実装ができた。背景なしとそれほど変わらない速さで出力できるし、メモリも（素材のサイズにもよるけど）それほど使いすぎないように制限した。

## 具体的な実装

1. ffmpeg で動画から画像に変換してディスクに書き出す
2. それを全てメモリに読み込む
3. そのうちの一定数を `ImageBitmap` にデコードして、フレームをキーにした `Map` に格納
4. ループ内で任意のフレームの `ImageBitmap` を取り出して canvas に `drawImage` する
5. 使用した `ImageBitmap` は `close` して、Map からも削除
6. Map に残っているアイテム数はループ内でチェックして、一定数以下になったら特定の数までデコードして増やす

## ポイント

- canvas は three.js の `scene.background` に `CanvasTexture` として渡すことで背景にしている。最初はいちいち新しい texture を作って切り替えていたけど、どう考えても canvas に描画する方がパフォーマンスが高い。
- 先に画像を一括でデコードしておくことで、ループ内で非同期処理を走らせないようにしている。パフォーマンス上も有利だが、そもそもループが非同期になるとコマ送りを保証するのが難しい。
- `ImageBitmap` は当然ながらサイズがバカデカい。ディスク上で合計 50MB くらいの画像の配列が、全部デコードすると約 2.5GB になる。キュー（Map）が枯渇しないようにするにはあまり少なくてもいけないが、メモリ的にはできるだけ減らしたい。リアルタイム再生しない限りはキューが枯渇することはないだろうし、現状は楽観的な実装しかしていない。
